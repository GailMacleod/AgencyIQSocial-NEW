Provide targeted fixes for deployment authentication failures in a Replit-hosted Node.js/Express app (AgencyIQ for social media automation), where dev works perfectly but prod sign-in fails with 'Session expired (absolute timeout)' and redirects to /api/login. Issues from report: Session cookie secure:true requires HTTPS but deployment mishandles it; env vars like SESSION_SECRET/DATABASE_URL mismatch in prod; CORS origins hardcoded to dev, failing on app.theagencyiq.ai; PG session store (connect-pg-simple) not connecting in prod; OAuth Passport strategies conflicting on init; NODE_ENV=production detection insufficient; dev auto-establish logic for User ID 2 inappropriate for prod.

Stack: Express with express-session (PG store via connect-pg-simple), Passport for OAuth (Twitter/Facebook/Instagram), Drizzle/Postgres, React frontend. No functional code changesâ€”only config/env adjustments to match prod requirements. Preserve all core logic: session destroy/clear on logout, quota calc from postLedger/videoUsage, auto-posting cron with token refresh/quota gates, onboarding wizard steps, OAuth refresh/revoke, video upload/approve/deduct.

Fixes:

Session Cookies: Set cookie { secure: process.env.NODE_ENV === 'production' ? true : false, sameSite: 'lax', httpOnly: true, maxAge: 72460601000 } in session middleware to handle Replit prod HTTPS proxy. Extend absolute timeout to avoid early expiry.
Env Validation: Add startup code to validate/log env vars (SESSION_SECRET, DATABASE_URL, OAuth keys) on app boot; suggest Replit secrets setup for prod DB string to ensure connection.
CORS: Update cors middleware to { origin: (origin, cb) => cb(null, origin === 'https://app.theagencyiq.ai' || origin === 'http://localhost:3000'), credentials: true, methods: ['GET', 'POST', 'PUT', 'DELETE'], allowedHeaders: ['Content-Type', 'Authorization'] }.
Session Store: Wrap PG store init in try-catch with logging for connection errors; add fallback to memory store if prod fails (e.g., if (!process.env.DATABASE_URL) use MemoryStore).
OAuth Init: Sequence Passport.use strategies after app.use(session), add try-catch logging for prod load conflicts; verify prod OAuth client IDs/secrets in env.
Env Detection: Define isProd = process.env.REPLIT_DEPLOYED === 'true' || process.env.NODE_ENV === 'production'; use to disable dev auto-establish (e.g., if (!isProd) autoLoginUser(2)).
Testing/Validation: Output test steps for prod deploy: Sign in (check session persistence >7 days without timeout), logout (verify cookies cleared, no stale quota in hamburger), access protected routes like /api/quota (200 with auth).
Output: Diff patches for server.ts (middleware/routes/init), updated .env example for prod, Replit deploy commands. Ensure no regressions in sessions (clear on logout), quotas (ledger updates), auto-posting (cron runs), onboarding (steps complete), OAuth (tokens refresh), video (costs deduct). Focus on surgical changes only."